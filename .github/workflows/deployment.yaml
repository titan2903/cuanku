name: Deploy to Production Server

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Deploy to Production Server
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  script: |
                    # Pindah ke direktori proyek Anda di server
                    # Ganti path ini jika berbeda
                    cd /root/project/cuanku
                    
                    echo "ğŸ”„ Mengambil kode terbaru dari branch main..."
                    git checkout main
                    git pull origin main

                    echo "ğŸ“¦ Menginstal dependensi Composer..."
                    composer install --no-dev --optimize-autoloader

                    echo "ğŸ“¦ Membangun aset frontend (JavaScript/CSS)..."
                    npm install
                    npm run build

                    # Atur izin file yang benar setelah deployment
                    echo "ğŸ” Mengatur izin file..."
                    chown -R cuanku-user:cuanku-user .
                    chmod -R 775 storage bootstrap/cache

                    echo "ğŸ”„ Menjalankan migrasi dan optimisasi Laravel..."
                    php artisan migrate --force
                    php artisan config:cache
                    php artisan route:cache
                    php artisan view:cache
                    php artisan optimize

                    echo "ğŸ‰ Deployment selesai!"
