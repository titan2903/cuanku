name: Deploy to Production Server

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Install sshpass
              run: |
                  sudo apt-get update
                  sudo apt-get install -y sshpass

            - name: Deploy to server
              run: |
                  sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh \
                    -o StrictHostKeyChecking=no \
                    -p ${{ secrets.SERVER_PORT }} \
                    ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} <<'ENDSSH'
                        # âœ… Muat environment NVM secara eksplisit untuk sesi non-interaktif
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

                        # Pindah ke direktori proyek Anda di server
                        # Ganti path ini jika berbeda
                        cd /home/cuanku-pm2/htdocs/cuanku.web.id

                        # Verify PM2 path and version
                        echo "ğŸ” Lokasi PM2: $(which pm2 2>/dev/null || echo 'PM2 tidak ditemukan')"
                        echo "ğŸ“Š Versi PM2: $(pm2 -v 2>/dev/null || echo 'PM2 tidak terinstall')"

                        # Install PM2 jika belum ada
                        if ! command -v pm2 &> /dev/null; then
                            echo "âš ï¸ PM2 tidak ditemukan, menginstall..."
                            npm install -g pm2
                        fi

                        echo "ğŸ”„ Mengambil kode terbaru dari branch main..."
                        git checkout main
                        git pull origin main

                        echo "ğŸ“¦ Menginstal dependensi Composer..."
                        composer install --no-dev --optimize-autoloader

                        echo "ğŸ“¦ Membangun aset frontend (JavaScript/CSS)..."
                        npm install
                        npm run build

                        # Atur izin file yang benar setelah deployment
                        echo "ğŸ” Mengatur izin file..."
                        # Menggunakan user situs yang benar (cuanku-pm2)
                        chown -R cuanku-pm2:cuanku-pm2 .
                        chmod -R 775 storage bootstrap/cache

                        echo "ğŸ”„ Menjalankan migrasi dan optimisasi Laravel..."
                        php artisan migrate --force
                        php artisan config:cache
                        php artisan route:cache
                        php artisan view:cache
                        php artisan optimize

                        # Menjalankan atau merestart aplikasi dengan PM2 menggunakan file ecosystem
                        echo "ğŸš€ Menjalankan aplikasi dengan PM2..."
                        # 'pm2 startOrReload' akan menjalankan jika belum ada, atau me-reload jika sudah ada.
                        pm2 startOrReload ecosystem.config.js

                        # Setup startup script dan simpan konfigurasi
                        echo "âš™ï¸ Konfigurasi startup pada boot..."
                        pm2 startup
                        pm2 save

                        # cek status PM2
                        pm2 status

                        echo "ğŸ‰ Deployment selesai!"
                  ENDSSH
