name: Deploy to Production Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Deploy to server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SERVER_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} <<'ENDSSH'
                # âœ… Muat environment NVM secara eksplisit untuk sesi non-interaktif
                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

                # Pindah ke direktori proyek Anda di server
                # Ganti path ini jika berbeda
                cd /home/cuanku-pm2/htdocs/cuanku.web.id

                # Verify PM2 path and version
                echo "ðŸ” Lokasi PM2: $(which pm2 2>/dev/null || echo 'PM2 tidak ditemukan')"
                echo "ðŸ“Š Versi PM2: $(pm2 -v 2>/dev/null || echo 'PM2 tidak terinstall')"

                # Install PM2 jika belum ada
                if ! command -v pm2 &> /dev/null; then
                    echo "âš ï¸ PM2 tidak ditemukan, menginstall..."
                    npm install -g pm2
                fi

                echo "ðŸ”„ Mengambil kode terbaru dari branch main..."
                git checkout main
                git pull origin main

                echo "ðŸ“¦ Menginstal dependensi Composer..."
                composer install --no-dev --optimize-autoloader

                echo "ðŸ“¦ Membangun aset frontend (JavaScript/CSS)..."
                npm install
                npm run build

                # Atur izin file yang benar setelah deployment
                echo "ðŸ” Mengatur izin file..."
                # Menggunakan user situs yang benar (cuanku-pm2)
                chown -R cuanku-pm2:cuanku-pm2 .
                chmod -R 775 storage bootstrap/cache

                echo "ðŸ”„ Menjalankan migrasi dan optimisasi Laravel..."
                php artisan migrate --force
                php artisan config:cache
                php artisan route:cache
                php artisan view:cache
                php artisan optimize

                # Buat ecosystem file untuk PM2 jika belum ada
                if [ ! -f ecosystem.config.js ]; then
                    echo "ðŸ“ Membuat konfigurasi PM2..."
                    tee ecosystem.config.js > /dev/null <<'EOF'
                    module.exports = {
                    apps: [{
                        name: "cuanku-app",
                        script: "php",
                        args: "artisan serve --host=127.0.0.1 --port=8000",
                        env: {
                        APP_ENV: "production",
                        NODE_ENV: "production"
                        },
                        watch: false,
                        instances: 1,
                        exec_mode: "fork",
                        max_memory_restart: "200M",
                        restart_delay: 3000
                    },
                    {
                        name: "cuanku-queue",
                        script: "php",
                        args: "artisan queue:work --tries=3 --timeout=90",
                        env: {
                        APP_ENV: "production",
                        NODE_ENV: "production"
                        },
                        watch: false,
                        instances: 1,
                        exec_mode: "fork",
                        max_memory_restart: "150M"
                    }]
                    }
                    EOF
                fi

                # Menjalankan/merestart aplikasi dengan PM2
                echo "ðŸš€ Menjalankan aplikasi dengan PM2..."
                if pm2 list | grep -q "cuanku-app"; then
                    echo "â™»ï¸ Merestart aplikasi yang sudah ada..."
                    pm2 reload ecosystem.config.js
                else
                    echo "ðŸ†• Menjalankan aplikasi baru..."
                    pm2 start ecosystem.config.js
                fi

                # Setup startup script
                echo "âš™ï¸ Konfigurasi startup pada boot..."
                pm2 startup | grep -v "sudo" | bash || echo "âš ï¸ PM2 startup tidak berhasil, perlu akses sudo"
                pm2 save

                # Monitoring
                echo "ðŸ“Š Status PM2:"
                pm2 status
                echo "ðŸ“ˆ Monitoring aplikasi (ctrl+c untuk keluar):"
                pm2 monit --mini || echo "Monitoring hanya tersedia di sesi interaktif"
                
                echo "ðŸŽ‰ Deployment selesai!"
          ENDSSH
