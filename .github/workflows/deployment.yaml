name: Deploy to Production Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Deploy to server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SERVER_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} <<'ENDSSH'
              # Pindah ke direktori proyek Anda di server
              # Ganti path ini jika berbeda
              cd /home/cuanku-pm2/htdocs/cuanku.web.id

              echo "ðŸ”„ Mengambil kode terbaru dari branch main..."
              git checkout main
              git pull origin main

              echo "ðŸ“¦ Menginstal dependensi Composer..."
              composer install --no-dev --optimize-autoloader

              echo "ðŸ“¦ Membangun aset frontend (JavaScript/CSS)..."
              npm install
              npm run build

              # Atur izin file yang benar setelah deployment
              echo "ðŸ” Mengatur izin file..."
              # Menggunakan user situs yang benar (cuanku-pm2)
              chown -R cuanku-pm2:cuanku-pm2 .
              chmod -R 775 storage bootstrap/cache

              echo "ðŸ”„ Menjalankan migrasi dan optimisasi Laravel..."
              php artisan migrate --force
              php artisan config:cache
              php artisan route:cache
              php artisan view:cache
              php artisan optimize

              # Menjalankan aplikasi dengan PM2
              echo "ðŸš€ Menjalankan atau merestart aplikasi dengan PM2..."
              # --host=127.0.0.1 agar hanya bisa diakses dari dalam server
              # 'pm2 reload' akan me-restart tanpa downtime jika sudah berjalan
              pm2 reload cuanku-app || pm2 start --name cuanku-php "php artisan serve --host=0.0.0.0 --port=8000"
              pm2 reload cuanku-vite || pm2 start --name cuanku-vite "npm run dev"

              # Simpan daftar proses PM2 agar otomatis berjalan setelah reboot server
              pm2 startup
              pm2 save

              # cek status PM2
              pm2 status

              echo "ðŸŽ‰ Deployment selesai!"
          ENDSSH
