name: Deploy to Production Server

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Deploy to Production Server
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  script: |
                      cd /root/project/cuanku
                      git checkout main
                      git pull origin main

                      # Check system resources before build
                      echo "ğŸ” Checking system resources..."
                      echo "ğŸ“Š Disk space:"
                      df -h /
                      echo "ğŸ“Š Memory usage:"
                      free -h
                      echo "ğŸ“Š Docker daemon status:"
                      sudo systemctl is-active docker

                      # Check if we have enough space (at least 2GB free)
                      available_space=$(df / | tail -1 | awk '{print $4}')
                      if [ $available_space -lt 2097152 ]; then # 2GB in KB
                          echo "âš ï¸ Low disk space detected. Cleaning up..."
                          docker system prune -af
                          docker volume prune -f
                      fi

                      # Stop existing containers (if any)
                      docker compose down

                      # Clean up Docker resources before build
                      echo "ğŸ§¹ Cleaning up Docker resources..."
                      docker system prune -f
                      docker volume prune -f
                      docker image prune -f

                      # Build Docker images with retry logic
                      echo "ğŸ”¨ Building Docker images..."
                      export DOCKER_BUILDKIT=1
                      export COMPOSE_DOCKER_CLI_BUILD=1
                      
                      build_retry=0
                      max_retries=3

                      while [ $build_retry -lt $max_retries ]; do
                          echo "Build attempt $((build_retry + 1))/$max_retries"
                          
                          if docker compose build --no-cache --force-rm; then
                              echo "âœ… Docker build completed successfully"
                              break
                          else
                              build_retry=$((build_retry + 1))
                              if [ $build_retry -lt $max_retries ]; then
                                  echo "âš ï¸ Build failed, retrying in 30 seconds..."
                                  sleep 30
                                  # Clean up before retry
                                  docker system prune -f
                              else
                                  echo "âŒ Docker build failed after $max_retries attempts"
                                  echo "ğŸ“‹ Checking Docker daemon status..."
                                  sudo systemctl status docker
                                  echo "ğŸ“‹ Recent Docker logs:"
                                  sudo journalctl -u docker --no-pager --lines=20
                                  exit 1
                              fi
                          fi
                      done

                      # Build assets with Node.js (production) with retry
                      echo "Building frontend assets..."
                      asset_retry=0
                      max_asset_retries=2

                      while [ $asset_retry -lt $max_asset_retries ]; do
                          echo "Asset build attempt $((asset_retry + 1))/$max_asset_retries"
                          
                          if docker compose --profile build up node-build; then
                              echo "âœ… Frontend assets build completed successfully"
                              break
                          else
                              asset_retry=$((asset_retry + 1))
                              if [ $asset_retry -lt $max_asset_retries ]; then
                                  echo "âš ï¸ Asset build failed, retrying..."
                                  sleep 15
                                  docker compose rm -f node-build
                              else
                                  echo "âŒ Asset build failed after $max_asset_retries attempts"
                                  echo "ğŸ“‹ Node build container logs:"
                                  docker compose logs node-build
                                  # Continue anyway - assets might exist from previous build
                                  echo "âš ï¸ Continuing deployment without fresh assets..."
                              fi
                          fi
                      done

                      # Remove node-build container after completion
                      docker compose rm -f node-build

                      # Start the application with health check
                      echo "Starting Laravel application..."
                      if docker compose up -d app; then
                          echo "âœ… Container started successfully"
                      else
                          echo "âŒ Failed to start container"
                          echo "ğŸ“‹ Container logs:"
                          docker compose logs app
                          echo "ğŸ“‹ Docker system info:"
                          docker system df
                          exit 1
                      fi

                      # Wait for container to be healthy with extended timeout
                      echo "Waiting for application to be ready..."
                      timeout=120  # Extended timeout to 2 minutes
                      health_check_interval=10
                      
                      while [ $timeout -gt 0 ]; do
                          # Check if container is running first
                          if ! docker compose ps app | grep -q "Up"; then
                              echo "âŒ Container is not running"
                              docker compose logs --tail=50 app
                              exit 1
                          fi
                          
                          # Check if application responds
                          if docker compose exec -T app curl -f http://localhost/ >/dev/null 2>&1; then
                              echo "âœ… Application is ready!"
                              break
                          fi
                          
                          echo "Waiting... ($timeout seconds remaining)"
                          sleep $health_check_interval
                          timeout=$((timeout-health_check_interval))
                      done

                      if [ $timeout -eq 0 ]; then
                          echo "âŒ Application failed to start within timeout"
                          echo "ğŸ“‹ Container status:"
                          docker compose ps
                          echo "ğŸ“‹ Application logs:"
                          docker compose logs --tail=100 app
                          echo "ğŸ“‹ System resources:"
                          free -h
                          df -h
                          exit 1
                      fi

                      # Create database if not exists (using external connection)
                      echo "ğŸ”„ Creating database if not exists..."
                      docker exec mysql mysql -u root -pfah6w2yfG2JL7Jk -e "CREATE DATABASE IF NOT EXISTS cuanku CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" || echo "Database creation skipped"

                      # Test external database connectivity
                      echo "ğŸ” Testing external database connectivity..."
                      docker compose exec -T app php -r "echo (gethostbyname('176.100.37.75') !== '176.100.37.75') ? 'DNS resolved' : 'Using direct IP';" || echo "Network test skipped"

                      # Test database connection
                      echo "ğŸ”„ Testing database connection..."
                      if docker compose exec -T app php artisan tinker --execute="
                      try {
                          DB::connection()->getPdo();
                          echo 'Database connected successfully!';
                      } catch (Exception \$e) {
                          echo 'Database connection failed: ' . \$e->getMessage();
                          exit(1);
                      }
                      " 2>/dev/null; then
                          echo "âœ… Database connection successful"
                      else
                          echo "âŒ Database connection failed"
                          echo "Checking container logs..."
                          docker compose logs --tail=20 app
                          echo "Testing direct database connection..."
                          docker compose exec -T app php -r "
                          try {
                              \$pdo = new PDO('mysql:host=176.100.37.75;port=3307', 'root', 'fah6w2yfG2JL7Jk');
                              echo 'Direct connection successful';
                          } catch (Exception \$e) {
                              echo 'Direct connection failed: ' . \$e->getMessage();
                          }
                          " || echo "Direct connection test failed"
                          exit 1
                      fi

                      # Run Laravel-specific commands including MIGRATION
                      echo "Running Laravel migrations and optimizations..."
                      
                      # Clear all caches first to ensure fresh config
                      echo "ğŸ”„ Clearing Laravel caches..."
                      docker compose exec -T app php artisan config:clear || echo "Config clear skipped"
                      docker compose exec -T app php artisan cache:clear || echo "Cache clear skipped" 
                      docker compose exec -T app php artisan route:clear || echo "Route clear skipped"
                      docker compose exec -T app php artisan view:clear || echo "View clear skipped"
                      echo "âœ… Caches cleared"
                      
                      # Run database migrations with error handling
                      echo "ğŸ”„ Running database migrations..."
                      if docker compose exec -T app php artisan migrate --force; then
                          echo "âœ… Database migrations completed successfully"
                      else
                          echo "âŒ Database migrations failed"
                          echo "ğŸ“‹ Checking migration status..."
                          docker compose exec -T app php artisan migrate:status || echo "Migration status check failed"
                          echo "ğŸ“‹ Application logs:"
                          docker compose logs --tail=50 app
                          echo "ğŸ“‹ Checking database connection again..."
                          docker compose exec -T app php artisan tinker --execute="
                          try {
                              DB::connection()->getPdo();
                              echo 'Database still connected';
                          } catch (Exception \$e) {
                              echo 'Database connection lost: ' . \$e->getMessage();
                          }
                          " || echo "Database recheck failed"
                          exit 1
                      fi
                      
                      # Run Laravel optimizations
                      echo "ğŸ”„ Running Laravel optimizations..."
                      docker compose exec -T app php artisan config:cache
                      docker compose exec -T app php artisan route:cache
                      docker compose exec -T app php artisan view:cache
                      docker compose exec -T app php artisan optimize
                      echo "âœ… Laravel optimizations completed"
                      
                      # Create admin user if not exists
                      echo "ğŸ”„ Checking admin user..."
                      docker compose exec -T app php artisan tinker --execute="
                      \$admin = \App\Models\User::where('name', 'admin')->first();
                      if (!\$admin) {
                          \App\Models\User::create([
                              'name' => 'admin',
                              'email' => 'admin@cuanku.local',
                              'password' => bcrypt('admin123'),
                              'is_active' => true,
                              'role' => 'admin',
                          ]);
                          echo 'Admin user created with email: admin@cuanku.local and password: admin123';
                      } else {
                          echo 'Admin user already exists';
                      }
                      " 2>/dev/null || echo "Admin user creation skipped"

                      # Clean up unused Docker resources
                      docker system prune -f

                      # Verify deployment
                      echo "Verifying deployment..."
                      if docker compose exec -T app php artisan --version >/dev/null 2>&1; then
                          echo "âœ… Laravel is running successfully"
                      else
                          echo "âŒ Laravel verification failed"
                          exit 1
                      fi

                      # Output deployment status
                      echo "ğŸ‰ Deployment completed successfully"
                      echo "ğŸ“‹ Final status check:"
                      echo "Container status:"
                      docker compose ps
                      echo "System resources after deployment:"
                      free -h
                      df -h /
                      
                      # Clean up unused Docker resources (do this once at the end)
                      docker system prune -f

                      # Show application logs (last 20 lines)
                      echo "ğŸ“‹ Recent application logs:"
                      docker compose logs --tail=20 app
