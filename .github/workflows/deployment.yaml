name: Deploy to Production Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Deploy to server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SERVER_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} <<'ENDSSH'
                # ✅ Muat environment NVM secara eksplisit untuk sesi non-interaktif
                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

                # Pindah ke direktori proyek Anda di server
                # Ganti path ini jika berbeda
                cd /home/cuanku-pm2/htdocs/cuanku.web.id

                # Verify PM2 path and version
                echo "🔍 Lokasi PM2: $(which pm2 2>/dev/null || echo 'PM2 tidak ditemukan')"
                echo "📊 Versi PM2: $(pm2 -v 2>/dev/null || echo 'PM2 tidak terinstall')"

                # Install PM2 jika belum ada
                if ! command -v pm2 &> /dev/null; then
                    echo "⚠️ PM2 tidak ditemukan, menginstall..."
                    npm install -g pm2
                fi

                echo "🔄 Mengambil kode terbaru dari branch main..."
                git checkout main
                git pull origin main

                echo "📦 Menginstal dependensi Composer..."
                composer install --no-dev --optimize-autoloader

                echo "📦 Membangun aset frontend (JavaScript/CSS)..."
                npm install
                npm run build

                # Atur izin file yang benar setelah deployment
                echo "🔐 Mengatur izin file..."
                # Menggunakan user situs yang benar (cuanku-pm2)
                chown -R cuanku-pm2:cuanku-pm2 .
                chmod -R 775 storage bootstrap/cache

                echo "🔄 Menjalankan migrasi dan optimisasi Laravel..."
                php artisan migrate --force
                php artisan config:cache
                php artisan route:cache
                php artisan view:cache
                php artisan optimize

                # Buat file ecosystem.config.js menggunakan perintah 'tee'
                # Ini lebih andal daripada heredoc di dalam skrip SSH.
                echo "📝 Membuat atau memperbarui konfigurasi PM2..."
                tee ecosystem.config.js > /dev/null <<'EOF'
                module.exports = {
                apps: [{
                    name: "cuanku-app",
                    script: "php",
                    args: "artisan serve --host=127.0.0.1 --port=8000",
                    env: {
                    APP_ENV: "production",
                    NODE_ENV: "production"
                    },
                    watch: false,
                    instances: 1,
                    exec_mode: "fork",
                    max_memory_restart: "200M",
                    restart_delay: 3000
                },
                {
                    name: "cuanku-queue",
                    script: "php",
                    args: "artisan queue:work --tries=3 --timeout=90",
                    env: {
                    APP_ENV: "production",
                    NODE_ENV: "production"
                    },
                    watch: false,
                    instances: 1,
                    exec_mode: "fork",
                    max_memory_restart: "150M"
                }]
                }
                EOF

                # Menjalankan atau merestart aplikasi dengan PM2
                echo "🚀 Menjalankan aplikasi dengan PM2..."
                # 'pm2 startOrReload' akan menjalankan jika belum ada, atau me-reload jika sudah ada.
                pm2 startOrReload ecosystem.config.js

                # Setup startup script dan simpan konfigurasi
                echo "⚙️ Konfigurasi startup pada boot..."
                pm2 startup
                pm2 save

                echo "🎉 Deployment selesai!"

          ENDSSH
