name: Deploy to Production Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # Muat environment NVM secara eksplisit untuk sesi non-interaktif
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            # Pindah ke direktori proyek Anda di server
            cd /home/cuanku-pm2/htdocs/cuanku.web.id

            echo "ðŸ”„ Mengambil kode terbaru dari branch main..."
            git pull origin main

            echo "ðŸ“¦ Menginstal dependensi Composer..."
            composer install --no-dev --optimize-autoloader

            echo "ðŸ“¦ Membangun aset frontend (JavaScript/CSS)..."
            npm install
            npm run build

            echo "ðŸ” Mengatur izin file..."
            chown -R cuanku-pm2:cuanku-pm2 .
            chmod -R 775 storage bootstrap/cache

            echo "ðŸ”„ Menjalankan migrasi dan optimisasi Laravel..."
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize

            # Buat file ecosystem.config.js menggunakan perintah 'tee'
            # Ini lebih andal daripada heredoc di dalam skrip SSH.
            echo "ðŸ“ Membuat atau memperbarui konfigurasi PM2..."
            tee ecosystem.config.js > /dev/null <<'EOF'
            module.exports = {
            apps: [{
                name: "cuanku-app",
                script: "php",
                args: "artisan serve --host=127.0.0.1 --port=8000",
                env: {
                APP_ENV: "production",
                NODE_ENV: "production"
                },
                watch: false,
                instances: 1,
                exec_mode: "fork",
                max_memory_restart: "200M",
                restart_delay: 3000
            },
            {
                name: "cuanku-queue",
                script: "php",
                args: "artisan queue:work --tries=3 --timeout=90",
                env: {
                APP_ENV: "production",
                NODE_ENV: "production"
                },
                watch: false,
                instances: 1,
                exec_mode: "fork",
                max_memory_restart: "150M"
            }]
            }
            EOF

            # Menjalankan atau merestart aplikasi dengan PM2
            echo "ðŸš€ Menjalankan aplikasi dengan PM2..."
            # 'pm2 startOrReload' akan menjalankan jika belum ada, atau me-reload jika sudah ada.
            pm2 startOrReload ecosystem.config.js

            # Setup startup script dan simpan konfigurasi
            echo "âš™ï¸ Konfigurasi startup pada boot..."
            pm2 startup
            pm2 save

            echo "ðŸŽ‰ Deployment selesai!"
