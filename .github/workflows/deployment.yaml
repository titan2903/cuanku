name: Deploy to Production Server

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Deploy to Production Server
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  script: |
                      cd /root/project/cuanku
                      git checkout main
                      git pull origin main

                      # Stop existing containers (if any)
                      docker compose down

                      # Build Docker images
                      docker compose build

                      # Build assets with Node.js (production)
                      echo "Building frontend assets..."
                      docker compose --profile build up node-build

                      # Remove node-build container after completion
                      docker compose rm -f node-build

                      # Start the application
                      echo "Starting Laravel application..."
                      docker compose up -d app

                      # Wait for container to be healthy
                      echo "Waiting for application to be ready..."
                      timeout=60
                      while [ $timeout -gt 0 ]; do
                          if docker compose exec -T app curl -f http://localhost/ >/dev/null 2>&1; then
                              echo "Application is ready!"
                              break
                          fi
                          echo "Waiting... ($timeout seconds remaining)"
                          sleep 5
                          timeout=$((timeout-5))
                      done

                      if [ $timeout -eq 0 ]; then
                          echo "Application failed to start within timeout"
                          exit 1
                      fi

                      # Create database if not exists (using external connection)
                      echo "ğŸ”„ Creating database if not exists..."
                      docker exec mysql mysql -u root -pfah6w2yfG2JL7Jk -e "CREATE DATABASE IF NOT EXISTS cuanku CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" || echo "Database creation skipped"

                      # Test external database connectivity
                      echo "ğŸ” Testing external database connectivity..."
                      docker compose exec -T app php -r "echo (gethostbyname('176.100.37.75') !== '176.100.37.75') ? 'DNS resolved' : 'Using direct IP';" || echo "Network test skipped"

                      # Test database connection
                      echo "ğŸ”„ Testing database connection..."
                      if docker compose exec -T app php artisan tinker --execute="
                      try {
                          DB::connection()->getPdo();
                          echo 'Database connected successfully!';
                      } catch (Exception \$e) {
                          echo 'Database connection failed: ' . \$e->getMessage();
                          exit(1);
                      }
                      " 2>/dev/null; then
                          echo "âœ… Database connection successful"
                      else
                          echo "âŒ Database connection failed"
                          echo "Checking container logs..."
                          docker compose logs --tail=20 app
                          echo "Testing direct database connection..."
                          docker compose exec -T app php -r "
                          try {
                              \$pdo = new PDO('mysql:host=176.100.37.75;port=3307', 'root', 'fah6w2yfG2JL7Jk');
                              echo 'Direct connection successful';
                          } catch (Exception \$e) {
                              echo 'Direct connection failed: ' . \$e->getMessage();
                          }
                          " || echo "Direct connection test failed"
                          exit 1
                      fi

                      # Run Laravel-specific commands including MIGRATION
                      echo "Running Laravel migrations and optimizations..."
                      
                      # Clear all caches first to ensure fresh config
                      echo "ğŸ”„ Clearing Laravel caches..."
                      docker compose exec -T app php artisan config:clear || echo "Config clear skipped"
                      docker compose exec -T app php artisan cache:clear || echo "Cache clear skipped" 
                      docker compose exec -T app php artisan route:clear || echo "Route clear skipped"
                      docker compose exec -T app php artisan view:clear || echo "View clear skipped"
                      echo "âœ… Caches cleared"
                      
                      # Run database migrations
                      echo "ğŸ”„ Running database migrations..."
                      if docker compose exec -T app php artisan migrate --force; then
                          echo "âœ… Database migrations completed successfully"
                      else
                          echo "âŒ Database migrations failed"
                          docker compose logs --tail=50 app
                          exit 1
                      fi
                      
                      # Run Laravel optimizations
                      echo "ğŸ”„ Running Laravel optimizations..."
                      docker compose exec -T app php artisan config:cache
                      docker compose exec -T app php artisan route:cache
                      docker compose exec -T app php artisan view:cache
                      docker compose exec -T app php artisan optimize
                      echo "âœ… Laravel optimizations completed"
                      
                      # Create admin user if not exists
                      echo "ğŸ”„ Checking admin user..."
                      docker compose exec -T app php artisan tinker --execute="
                      \$admin = \App\Models\User::where('name', 'admin')->first();
                      if (!\$admin) {
                          \App\Models\User::create([
                              'name' => 'admin',
                              'email' => 'admin@cuanku.local',
                              'password' => bcrypt('admin123'),
                              'is_active' => true,
                              'role' => 'admin',
                          ]);
                          echo 'Admin user created with email: admin@cuanku.local and password: admin123';
                      } else {
                          echo 'Admin user already exists';
                      }
                      " 2>/dev/null || echo "Admin user creation skipped"

                      # Clean up unused Docker resources
                      docker system prune -f

                      # Verify deployment
                      echo "Verifying deployment..."
                      if docker compose exec -T app php artisan --version >/dev/null 2>&1; then
                          echo "âœ… Laravel is running successfully"
                      else
                          echo "âŒ Laravel verification failed"
                          exit 1
                      fi

                      # Output deployment status
                      echo "ğŸ‰ Deployment completed successfully"
                      docker system prune -f
                      docker compose ps

                      # Show application logs (last 20 lines)
                      echo "ğŸ“‹ Recent application logs:"
                      docker compose logs --tail=20 app
